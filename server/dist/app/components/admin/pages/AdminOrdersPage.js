import { jsx as _jsx, jsxs as _jsxs, Fragment as _Fragment } from "react/jsx-runtime";
import { useState } from "react";
import { Search, Download, Eye, CheckCircle2, Truck, XCircle, MoreVertical, ChevronLeft, ChevronRight, ClipboardList, Mail, Phone } from "lucide-react";
import { useAdmin } from "../AdminContext";
import { formatPrice } from "../../data";
import { OrderDetailsModal } from "../OrderDetailsModal";
export function AdminOrdersPage() {
    const { orders, updateOrderStatus } = useAdmin();
    // State for filters
    const [search, setSearch] = useState("");
    const [status, setStatus] = useState("all");
    // State for pagination
    const [page, setPage] = useState(1);
    const itemsPerPage = 10;
    // State for Details Modal
    const [selectedOrder, setSelectedOrder] = useState(null);
    const [isDetailsOpen, setIsDetailsOpen] = useState(false);
    // State for popover menu
    const [openMenuId, setOpenMenuId] = useState(null);
    // Filter logic
    const filteredOrders = orders.filter(o => {
        const matchSearch = (o.name || o.customerName || '').toLowerCase().includes(search.toLowerCase()) ||
            (o.id || '').toLowerCase().includes(search.toLowerCase()) ||
            (o.customerDoc || '').includes(search);
        const matchStatus = status === "all" || o.status === status;
        return matchSearch && matchStatus;
    });
    const totalPages = Math.ceil(filteredOrders.length / itemsPerPage);
    const currentOrders = filteredOrders.slice((page - 1) * itemsPerPage, page * itemsPerPage);
    const handleOpenDetails = (order) => {
        setSelectedOrder(order);
        setIsDetailsOpen(true);
    };
    const getStatusBadge = (status) => {
        const config = {
            pending: "bg-amber-100 text-amber-700 border-amber-200",
            confirmed: "bg-emerald-100 text-emerald-700 border-emerald-200",
            shipped: "bg-blue-100 text-blue-700 border-blue-200",
            cancelled: "bg-red-100 text-red-700 border-red-200",
        };
        const labels = {
            pending: "Pendiente",
            confirmed: "Confirmado",
            shipped: "Enviado",
            cancelled: "Cancelado",
        };
        return (_jsx("span", { className: `px-2.5 py-1 rounded-full text-[11px] font-bold border ${config[status]}`, children: labels[status] }));
    };
    return (_jsxs("div", { className: "space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500", children: [_jsxs("div", { className: "flex flex-col sm:flex-row sm:items-center justify-between gap-4", children: [_jsxs("div", { children: [_jsx("h2", { className: "text-2xl font-bold text-foreground", style: { fontFamily: "Montserrat, sans-serif" }, children: "Facturaci\u00F3n y Pedidos" }), _jsx("p", { className: "text-muted-foreground text-[14px]", style: { fontFamily: "Inter, sans-serif" }, children: "Gestiona las solicitudes de cotizaci\u00F3n y pedidos en curso." })] }), _jsx("div", { className: "flex gap-2", children: _jsxs("button", { className: "flex items-center gap-2 px-4 py-2.5 rounded-xl text-[14px] font-bold bg-white text-foreground border border-border hover:bg-[#f8f9fb] transition-all shadow-sm", style: { fontFamily: "Inter, sans-serif" }, children: [_jsx(Download, { className: "w-4 h-4" }), "Reporte Mensual"] }) })] }), _jsxs("div", { className: "bg-white p-5 rounded-2xl border border-border shadow-sm flex flex-col md:flex-row gap-4", children: [_jsxs("div", { className: "flex-1 relative group", children: [_jsx(Search, { className: "absolute left-3.5 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground group-focus-within:text-[#0a4d8c] transition-colors" }), _jsx("input", { type: "text", placeholder: "Buscar por ID, Cliente o Documento...", value: search, onChange: (e) => setSearch(e.target.value), className: "w-full pl-10 pr-4 py-2.5 bg-[#f5f7fa] border border-transparent rounded-xl text-[14px] focus:bg-white focus:border-[#0a4d8c] focus:ring-4 focus:ring-[#0a4d8c]/5 outline-none transition-all", style: { fontFamily: "Inter, sans-serif" } })] }), _jsx("div", { className: "flex gap-2", children: _jsxs("select", { value: status, onChange: (e) => setStatus(e.target.value), className: "bg-white border border-border rounded-xl px-4 py-2.5 text-[14px] font-semibold outline-none focus:ring-2 focus:ring-[#0a4d8c]/10 cursor-pointer", style: { fontFamily: "Inter, sans-serif" }, children: [_jsx("option", { value: "all", children: "Todos los estados" }), _jsx("option", { value: "pending", children: "Pendientes" }), _jsx("option", { value: "confirmed", children: "Confirmados" }), _jsx("option", { value: "shipped", children: "Enviados" }), _jsx("option", { value: "cancelled", children: "Cancelados" })] }) })] }), _jsxs("div", { className: "bg-white rounded-2xl border border-border shadow-sm overflow-hidden", children: [_jsx("div", { className: "overflow-x-auto", children: _jsxs("table", { className: "w-full text-left", style: { fontFamily: "Inter, sans-serif" }, children: [_jsx("thead", { children: _jsxs("tr", { className: "bg-[#f8f9fb] text-[12px] text-muted-foreground font-bold uppercase tracking-wider", children: [_jsx("th", { className: "px-6 py-4", children: "ID Pedido / Fecha" }), _jsx("th", { className: "px-6 py-4", children: "Cliente / Contacto" }), _jsx("th", { className: "px-6 py-4", children: "Estado" }), _jsx("th", { className: "px-6 py-4 text-right", children: "Total" }), _jsx("th", { className: "px-6 py-4 text-right", children: "Acciones" })] }) }), _jsx("tbody", { className: "divide-y divide-border", children: currentOrders.map((order) => (_jsxs("tr", { className: "hover:bg-[#f8f9fb]/50 transition-colors group", children: [_jsx("td", { className: "px-6 py-4", children: _jsxs("div", { className: "flex flex-col", children: [_jsx("span", { className: "text-[13px] font-bold text-[#0a4d8c]", children: order.id }), _jsx("span", { className: "text-[11px] text-muted-foreground", children: new Date(order.date).toLocaleString("es-PE", { dateStyle: "medium", timeStyle: "short" }) })] }) }), _jsx("td", { className: "px-6 py-4", children: _jsxs("div", { className: "flex flex-col", children: [_jsx("span", { className: "text-[13px] font-bold text-foreground", children: order.name || order.customerName }), _jsxs("div", { className: "flex items-center gap-2 mt-0.5", children: [_jsx("span", { className: "text-[11px] px-1.5 py-0.5 bg-slate-100 rounded text-slate-600 font-bold", children: order.customerDoc }), _jsxs("div", { className: "flex gap-1.5 ml-1", children: [_jsx(Mail, { className: "w-3 h-3 text-muted-foreground" }), _jsx(Phone, { className: "w-3 h-3 text-muted-foreground" })] })] }), order.productSummary && (_jsx("p", { className: "text-[11px] text-[#0a4d8c] font-medium truncate max-w-[200px] mt-1 italic", children: order.productSummary }))] }) }), _jsx("td", { className: "px-6 py-4", children: getStatusBadge(order.status) }), _jsx("td", { className: "px-6 py-4 text-right", children: _jsxs("div", { className: "flex flex-col", children: [_jsx("span", { className: "text-[14px] font-bold text-foreground", children: formatPrice(order.total) }), _jsxs("span", { className: "text-[11px] text-muted-foreground", children: [order.items.length, " \u00EDtems"] })] }) }), _jsx("td", { className: "px-6 py-4 text-right", children: _jsxs("div", { className: "flex items-center justify-end gap-1", children: [_jsx("button", { onClick: () => handleOpenDetails(order), className: "p-2 hover:bg-muted text-foreground rounded-lg transition-colors", title: "Ver Detalles", children: _jsx(Eye, { className: "w-4 h-4" }) }), _jsxs("div", { className: "relative", children: [_jsx("button", { onClick: (e) => {
                                                                        e.stopPropagation();
                                                                        setOpenMenuId(openMenuId === order.id ? null : order.id);
                                                                    }, className: `p-2 rounded-lg transition-colors ${openMenuId === order.id ? "bg-[#0a4d8c]/10 text-[#0a4d8c]" : "hover:bg-muted text-muted-foreground"}`, children: _jsx(MoreVertical, { className: "w-4 h-4" }) }), openMenuId === order.id && (_jsxs(_Fragment, { children: [_jsx("div", { className: "fixed inset-0 z-10", onClick: () => setOpenMenuId(null) }), _jsx("div", { className: "absolute right-0 top-full mt-1 w-48 bg-white border border-border rounded-xl shadow-xl z-20 animate-in fade-in zoom-in-95 duration-200", children: _jsx("div", { className: "p-1.5", children: order.status === "confirmed" ? (_jsx("div", { className: "px-3 py-2 text-[12px] text-muted-foreground italic text-center", children: "Pedido ya confirmado (Finalizado)" })) : order.status === "cancelled" ? (_jsx("div", { className: "px-3 py-2 text-[12px] text-muted-foreground italic text-center", children: "Pedido cancelado" })) : order.status === "shipped" ? (_jsxs("button", { onClick: () => {
                                                                                        if (window.confirm("¿Está seguro de que desea confirmar la RECEPCIÓN de este pedido?")) {
                                                                                            updateOrderStatus(order.id, "confirmed");
                                                                                            setOpenMenuId(null);
                                                                                        }
                                                                                    }, className: "w-full flex items-center gap-2.5 px-3 py-2 text-[13px] text-foreground hover:bg-emerald-50 hover:text-emerald-700 rounded-lg transition-colors", children: [_jsx(CheckCircle2, { className: "w-4 h-4" }), " Marcar Confirmado"] })) : (_jsxs(_Fragment, { children: [_jsxs("button", { onClick: () => {
                                                                                                if (window.confirm("¿Está seguro de que desea marcar este pedido como ENVIADO?")) {
                                                                                                    updateOrderStatus(order.id, "shipped");
                                                                                                    setOpenMenuId(null);
                                                                                                }
                                                                                            }, className: "w-full flex items-center gap-2.5 px-3 py-2 text-[13px] text-foreground hover:bg-blue-50 hover:text-blue-700 rounded-lg transition-colors", children: [_jsx(Truck, { className: "w-4 h-4" }), " Marcar Enviado"] }), _jsxs("button", { onClick: () => {
                                                                                                if (window.confirm("¿Está realmente seguro de que desea CANCELAR este pedido?")) {
                                                                                                    updateOrderStatus(order.id, "cancelled");
                                                                                                    setOpenMenuId(null);
                                                                                                }
                                                                                            }, className: "w-full flex items-center gap-2.5 px-3 py-2 text-[13px] text-red-600 hover:bg-red-50 rounded-lg transition-colors", children: [_jsx(XCircle, { className: "w-4 h-4" }), " Cancelar Pedido"] })] })) }) })] }))] })] }) })] }, order.id))) })] }) }), totalPages > 1 && (_jsxs("div", { className: "px-6 py-4 bg-[#f8f9fb] border-t border-border flex items-center justify-between", children: [_jsxs("p", { className: "text-[13px] text-muted-foreground", children: ["Mostrando ", _jsx("span", { className: "font-bold text-foreground", children: currentOrders.length }), " de ", _jsx("span", { className: "font-bold text-foreground", children: filteredOrders.length }), " pedidos"] }), _jsxs("div", { className: "flex items-center gap-2", children: [_jsx("button", { onClick: () => setPage(prev => Math.max(1, prev - 1)), disabled: page === 1, className: "p-2 border border-border rounded-lg bg-white disabled:opacity-50 hover:bg-muted transition-colors", children: _jsx(ChevronLeft, { className: "w-4 h-4" }) }), _jsx("div", { className: "flex items-center gap-1", children: Array.from({ length: totalPages }, (_, i) => i + 1).map(n => (_jsx("button", { onClick: () => setPage(n), className: `w-8 h-8 rounded-lg text-[13px] font-bold transition-all ${page === n ? "bg-[#0a4d8c] text-white shadow-lg shadow-blue-500/20" : "hover:bg-muted text-foreground"}`, children: n }, n))) }), _jsx("button", { onClick: () => setPage(prev => Math.min(totalPages, prev + 1)), disabled: page === totalPages, className: "p-2 border border-border rounded-lg bg-white disabled:opacity-50 hover:bg-muted transition-colors", children: _jsx(ChevronRight, { className: "w-4 h-4" }) })] })] }))] }), _jsx(OrderDetailsModal, { isOpen: isDetailsOpen, onClose: () => setIsDetailsOpen(false), order: selectedOrder }), filteredOrders.length === 0 && (_jsxs("div", { className: "text-center py-20 bg-white rounded-2xl border border-dashed border-border", children: [_jsx(ClipboardList, { className: "w-12 h-12 text-muted-foreground mx-auto mb-4 opacity-30" }), _jsx("h3", { className: "text-lg font-bold text-foreground", style: { fontFamily: "Montserrat, sans-serif" }, children: "No se encontraron pedidos" }), _jsx("p", { className: "text-muted-foreground text-[14px] mt-1", style: { fontFamily: "Inter, sans-serif" }, children: "Intenta ajustar los filtros o el t\u00E9rmino de b\u00FAsqueda." })] }))] }));
}
